# GoHub - åŸºäºå¼€æºæ¡†æ¶çš„é«˜æ€§èƒ½åˆ†å¸ƒå¼ Go WebSocket æ¡†æ¶

[![Go ç‰ˆæœ¬](https://img.shields.io/badge/go%20version-%3E%3D1.20-6F93CF.svg)](https://golang.org/dl/)
[![è®¸å¯è¯: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

**GoHub** æ˜¯ä¸€ä¸ªåŸºäºGorilla WebSocketå¼€å‘çš„ã€å¼ºå¤§çš„åˆ†å¸ƒå¼WebSocketæ¡†æ¶ï¼Œä¸“ä¸ºé«˜å¹¶å‘å®æ—¶é€šä¿¡ç³»ç»Ÿè®¾è®¡ã€‚å…¶æ ¸å¿ƒä¼˜åŠ¿åœ¨äº**å®Œå…¨åˆ†å¸ƒå¼æ¶æ„è®¾è®¡**å’Œ**é«˜æ•ˆçš„æ¶ˆæ¯åˆ†å‘æœºåˆ¶**ï¼Œå¯è½»æ¾æ‰©å±•è‡³æ•°åä¸‡å¹¶å‘è¿æ¥ï¼ŒåŒæ—¶ä¿æŒé«˜ååé‡å’Œä½å»¶è¿Ÿã€‚

## ğŸŒŸ æ ¸å¿ƒäº®ç‚¹

### 1ï¸âƒ£ å®Œå…¨åˆ†å¸ƒå¼è®¾è®¡
- **æ— çŠ¶æ€èŠ‚ç‚¹æ‰©å±•**: æ¯ä¸ªGoHubèŠ‚ç‚¹éƒ½æ˜¯æ— çŠ¶æ€çš„ï¼Œå¯ä»¥éšæ—¶æ·»åŠ æˆ–ç§»é™¤ï¼Œå®ç°çœŸæ­£çš„æ°´å¹³æ‰©å±•
- **å¤šç§æ¶ˆæ¯æ€»çº¿é€‰æ‹©**: 
  - å†…ç½®æ”¯æŒNATSï¼ˆåŒ…æ‹¬JetStreamæŒä¹…åŒ–ï¼‰å’ŒRedisä½œä¸ºé«˜æ€§èƒ½æ¶ˆæ¯æ€»çº¿
  - èŠ‚ç‚¹é—´å®æ—¶é€šä¿¡ç¡®ä¿æ¶ˆæ¯åœ¨é›†ç¾¤ä¸­å‡†ç¡®ä¼ é€’
- **æ¶ˆæ¯å»é‡æœºåˆ¶**: ç¡®ä¿åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹æ¶ˆæ¯çš„ç²¾ç¡®ä¸€æ¬¡å¤„ç†
- **é›†ç¾¤çŠ¶æ€åŒæ­¥**: æˆ¿é—´ä¿¡æ¯å’Œå®¢æˆ·ç«¯çŠ¶æ€åœ¨é›†ç¾¤ä¸­è‡ªåŠ¨åŒæ­¥

### 2ï¸âƒ£ é«˜æ•ˆæ¶ˆæ¯åˆ†å‘ç³»ç»Ÿ
- **åŸºäºç±»å‹çš„ä¸­å¤®åˆ†å‘å™¨**: æ ¹æ®æ¶ˆæ¯ç±»å‹æ™ºèƒ½è·¯ç”±åˆ°å¯¹åº”å¤„ç†å™¨
- **è‡ªå®šä¹‰æ¶ˆæ¯å¤„ç†**: è½»æ¾æ‰©å±•æ¡†æ¶å¤„ç†ä¸šåŠ¡ç‰¹å®šæ¶ˆæ¯ç±»å‹
- **å¹¿æ’­ä¸å®šå‘æ¶ˆæ¯**: æ”¯æŒä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹å¤šç­‰å¤šç§é€šä¿¡æ¨¡å¼
- **æˆ¿é—´/é¢‘é“æœºåˆ¶**: å¼ºå¤§çš„æˆ¿é—´ç®¡ç†åŠŸèƒ½ï¼Œæ”¯æŒåŠ¨æ€åˆ›å»ºã€åŠ å…¥ã€ç¦»å¼€å’Œæ¶ˆæ¯å¹¿æ’­

## âœ¨ å…¶ä»–ä¸»è¦åŠŸèƒ½

* **é«˜çº§æˆ¿é—´/é¢‘é“ç®¡ç†**:
    * åˆ›å»ºã€åˆ é™¤å’Œåˆ—å‡ºæˆ¿é—´ï¼Œæ”¯æŒè·¨èŠ‚ç‚¹æˆ¿é—´æˆå‘˜ç®¡ç†
    * å…è®¸å®¢æˆ·ç«¯åŠ å…¥å’Œç¦»å¼€æˆ¿é—´ï¼Œå®æ—¶åŒæ­¥åˆ°æ‰€æœ‰èŠ‚ç‚¹
    * åœ¨ç‰¹å®šæˆ¿é—´å†…å¹¿æ’­æ¶ˆæ¯ï¼Œå³ä½¿æ¥æ”¶è€…åˆ†å¸ƒåœ¨ä¸åŒèŠ‚ç‚¹ä¸Š
    * æ”¯æŒæ¯ä¸ªæˆ¿é—´çš„æœ€å¤§å®¢æˆ·ç«¯æ•°é‡é™åˆ¶

* **çµæ´»çš„è®¤è¯ä¸æˆæƒ**:
    * åŸºäº JWT çš„è®¤è¯æœºåˆ¶
    * ç»†ç²’åº¦çš„æƒé™ç³»ç»Ÿ (ä¾‹å¦‚, `send:message`, `create:room`)
    * å¯é…ç½®çš„åŒ¿åè®¿é—®

* **å¯è§‚æµ‹æ€§**:
    * é›†æˆ Prometheus æŒ‡æ ‡ï¼Œç”¨äºç›‘æ§è¿æ¥æ•°ã€æ¶ˆæ¯é‡ã€æˆ¿é—´æ•°å’Œé”™è¯¯
    * ä½¿ç”¨ `log/slog` è¿›è¡Œç»“æ„åŒ–æ—¥å¿—è®°å½•
    * åˆ†å¸ƒå¼è·Ÿè¸ªæ”¯æŒï¼Œå¸®åŠ©å®šä½è·¨èŠ‚ç‚¹é—®é¢˜

* **æœåŠ¡ç«¯ SDK**:
    * æä¾›ä¾¿æ·çš„ SDKï¼Œç”¨äºå°† GoHub åŠŸèƒ½é›†æˆåˆ°æ‚¨çš„ä¸šåŠ¡é€»è¾‘ä¸­
    * äº‹ä»¶é©±åŠ¨ï¼šå¯è®¢é˜…å®¢æˆ·ç«¯è¿æ¥ã€æ–­å¼€ã€æ¶ˆæ¯å’Œæˆ¿é—´äº‹ä»¶

* **é…ç½®ç®¡ç†**:
    * é€šè¿‡ Viper ä½¿ç”¨ YAML æ–‡ä»¶å’Œç¯å¢ƒå˜é‡è¿›è¡Œçµæ´»é…ç½®
    * æ”¯æŒé…ç½®çƒ­åŠ è½½

* **é«˜æ€§èƒ½**: 
    * å•èŠ‚ç‚¹æ”¯æŒ10ä¸‡+å¹¶å‘è¿æ¥
    * é›†ç¾¤æ¨¡å¼å¯æ‰©å±•è‡³ç™¾ä¸‡çº§è¿æ¥
    * ä¼˜åŒ–çš„å†…å­˜ä½¿ç”¨ï¼Œå‡å°‘GCå‹åŠ›

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

* Go 1.20 æˆ–æ›´é«˜ç‰ˆæœ¬
* (ç”¨äºåˆ†å¸ƒå¼æ¨¡å¼) NATS Server (æ¨è v2.8+ï¼Œä½¿ç”¨ JetStream ä»¥æ”¯æŒæŒä¹…åŒ–) æˆ– Redis

### å®‰è£…

1. **å…‹éš†ä»“åº“:**
   ```bash
   git clone https://github.com/chenxilol/gohub.git
   cd gohub
   ```

2. **ä¸‹è½½ä¾èµ–:**
   ```bash
   go mod tidy
   ```

### é…ç½®

1. **å¤åˆ¶ç¤ºä¾‹é…ç½®æ–‡ä»¶:**
   ```bash
   cp configs/config.example.yaml configs/config.yaml
   ```

2. **ç¼–è¾‘ `configs/config.yaml`:**
   * å¯¹äº**åˆ†å¸ƒå¼é›†ç¾¤æ¨¡å¼**ï¼ˆæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰:
     ```yaml
     cluster:
       enabled: true
       bus_type: "nats"  # æˆ– "redis"
       nats:
         url: "nats://localhost:4222"
         # å¦‚æœä½¿ç”¨JetStreamæŒä¹…åŒ–
         stream_name: "gohub"
         durable_name: "gohub-durable"
     ```
   * å¯¹äºæ— éœ€å¤–éƒ¨ä¾èµ–çš„å¿«é€Ÿ**å•èŠ‚ç‚¹å¯åŠ¨**:
     ```yaml
     cluster:
       enabled: false
       bus_type: "noop"
     ```
   * æ›´æ–° `auth.secret_key` ç”¨äº JWT ç”Ÿæˆ

   *è¯·å‚è€ƒ `configs/config.example.yaml` æŸ¥çœ‹æ‰€æœ‰å¯ç”¨é€‰é¡¹*

### è¿è¡Œ GoHub

1. **ä»æºç è¿è¡Œ:**
   ```bash
   go run cmd/gohub/main.go -config configs/config.yaml
   ```
   é»˜è®¤æƒ…å†µä¸‹ï¼ŒæœåŠ¡å°†åœ¨ `config.yaml` ä¸­æŒ‡å®šçš„åœ°å€å¯åŠ¨ (ä¾‹å¦‚ï¼š`:8080`)ã€‚WebSocket ç«¯ç‚¹ä½äº `/ws`ã€‚

2. **ä½¿ç”¨ Docker é›†ç¾¤æ¨¡å¼ (ç”Ÿäº§ç¯å¢ƒæ¨è):**
   ```bash
   # å¯åŠ¨å®Œæ•´çš„åˆ†å¸ƒå¼ç¯å¢ƒ
   docker-compose up -d
   ```

## ğŸ’» åˆ†å¸ƒå¼WebSocketä½¿ç”¨ç¤ºä¾‹

### 1. é…ç½®å¤šèŠ‚ç‚¹é›†ç¾¤

å‡è®¾æˆ‘ä»¬è¦è®¾ç½®ä¸€ä¸ª3èŠ‚ç‚¹çš„GoHubé›†ç¾¤ï¼š

```bash
# èŠ‚ç‚¹1
go run cmd/gohub/main.go -config configs/node1.yaml

# èŠ‚ç‚¹2
go run cmd/gohub/main.go -config configs/node2.yaml

# èŠ‚ç‚¹3
go run cmd/gohub/main.go -config configs/node3.yaml
```

å„èŠ‚ç‚¹é…ç½®æ–‡ä»¶ä¸­éœ€è¦æŒ‡å‘ç›¸åŒçš„NATSæˆ–RedisæœåŠ¡ï¼š

```yaml
# node1.yaml, node2.yaml, node3.yaml ä¸­çš„å…±åŒé…ç½®
cluster:
  enabled: true
  bus_type: "nats"
  nats:
    url: "nats://localhost:4222"
    stream_name: "gohub"
```

### 2. å»ºç«‹WebSocketè¿æ¥

å‰ç«¯JavaScriptç¤ºä¾‹ï¼š

```javascript
// è¿æ¥åˆ°ä»»æ„GoHubèŠ‚ç‚¹
const socket = new WebSocket("ws://node1:8080/ws");  // å¯ä»¥æ˜¯é›†ç¾¤ä¸­ä»»æ„èŠ‚ç‚¹

socket.onopen = function(e) {
  console.log("WebSocketè¿æ¥å·²å»ºç«‹");
  
  // å‘é€è®¤è¯æ¶ˆæ¯
  const authMessage = {
    message_type: "authenticate",
    data: {
      token: "æ‚¨çš„JWTä»¤ç‰Œ"
    }
  };
  socket.send(JSON.stringify(authMessage));
};

socket.onmessage = function(event) {
  const message = JSON.parse(event.data);
  console.log("æ”¶åˆ°æ¶ˆæ¯:", message);
  
  // å¤„ç†æ¶ˆæ¯...
};
```

### 3. æˆ¿é—´åŠŸèƒ½è·¨èŠ‚ç‚¹å·¥ä½œ

å³ä½¿ç”¨æˆ·è¿æ¥åˆ°ä¸åŒèŠ‚ç‚¹ï¼ŒGoHubçš„åˆ†å¸ƒå¼ç‰¹æ€§ä¹Ÿèƒ½ç¡®ä¿æˆ¿é—´åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼š

```javascript
// ç”¨æˆ·Aï¼ˆè¿æ¥åˆ°èŠ‚ç‚¹1ï¼‰åˆ›å»ºå¹¶åŠ å…¥æˆ¿é—´
function joinRoom(roomId) {
  socket.send(JSON.stringify({
    message_id: Date.now(),
    message_type: "join_room",
    data: { room_id: roomId }
  }));
}

// ç”¨æˆ·Bï¼ˆè¿æ¥åˆ°èŠ‚ç‚¹2ï¼‰ä¹Ÿå¯ä»¥åŠ å…¥åŒä¸€æˆ¿é—´å¹¶å‘é€æ¶ˆæ¯
// æ¶ˆæ¯ä¼šé€šè¿‡æ¶ˆæ¯æ€»çº¿åŒæ­¥åˆ°æ‰€æœ‰èŠ‚ç‚¹
function sendRoomMessage(roomId, content) {
  socket.send(JSON.stringify({
    message_id: Date.now(),
    message_type: "room_message",
    data: {
      room_id: roomId,
      content: content
    }
  }));
}
```

## ğŸ“Š ä¸å…¶ä»–WebSocketæ¡†æ¶å¯¹æ¯”

| ç‰¹æ€§ | GoHub | Melody | Gorilla WebSocket | go-netty-ws |
|------|-------|--------|-------------------|-------------|
| **åˆ†å¸ƒå¼æ”¯æŒ** | âœ… å®Œå…¨å†…ç½® | âŒ æ—  | âŒ æ—  | âš ï¸ æœ‰é™ |
| **è·¨èŠ‚ç‚¹æ¶ˆæ¯ä¼ é€’** | âœ… NATS/Redis | âŒ éœ€è‡ªè¡Œå®ç° | âŒ éœ€è‡ªè¡Œå®ç° | âš ï¸ æœ‰é™ |
| **æ¶ˆæ¯åˆ†å‘æœºåˆ¶** | âœ… ç±»å‹åŒ–è·¯ç”± | âŒ ç®€å•å›è°ƒ | âŒ åŸºç¡€æ¥å£ | âš ï¸ æœ‰é™ |
| æˆ¿é—´/é¢‘é“ç®¡ç† | âœ… å†…ç½® | âš ï¸ æœ‰é™æ”¯æŒ | âŒ éœ€è‡ªè¡Œå®ç° | âŒ éœ€è‡ªè¡Œå®ç° |
| è®¤è¯ä¸æˆæƒ | âœ… JWT + ç»†ç²’åº¦æƒé™ | âŒ éœ€è‡ªè¡Œå®ç° | âŒ éœ€è‡ªè¡Œå®ç° | âŒ éœ€è‡ªè¡Œå®ç° |
| æŒ‡æ ‡ç›‘æ§ | âœ… Prometheus | âŒ éœ€è‡ªè¡Œå®ç° | âŒ éœ€è‡ªè¡Œå®ç° | âŒ éœ€è‡ªè¡Œå®ç° |
| SDKæ”¯æŒ | âœ… æœåŠ¡ç«¯ | âŒ æ—  | âŒ æ—  | âš ï¸ æœ‰é™ |
| æ´»è·ƒç»´æŠ¤ | âœ… æ˜¯ | âš ï¸ æœ‰é™ | âœ… æ˜¯ | âš ï¸ æœ‰é™ |

## ğŸš€ æ€§èƒ½åŸºå‡†

GoHubåœ¨åˆ†å¸ƒå¼æ¨¡å¼ä¸‹ä¾ç„¶ä¿æŒå‡ºè‰²æ€§èƒ½ï¼š

| é…ç½® | è¿æ¥æ•°é‡ | å†…å­˜ä½¿ç”¨ | æ¯ç§’æ¶ˆæ¯å¤„ç†èƒ½åŠ› |
|------|--------|---------|----------------|
| å•èŠ‚ç‚¹ | 10,000 | ~281MB | >10,000 |
| å•èŠ‚ç‚¹ | 100,000 | ~2.7GB | >5,000 |
| 3èŠ‚ç‚¹é›†ç¾¤ | 300,000 | ~8.1GB (æ€»è®¡) | >15,000 (æ€»è®¡) |
| 5èŠ‚ç‚¹é›†ç¾¤ | 500,000 | ~13.5GB (æ€»è®¡) | >25,000 (æ€»è®¡) |

*æ³¨æ„ï¼šå®é™…æ€§èƒ½å¯èƒ½å› ç¡¬ä»¶é…ç½®ã€æ¶ˆæ¯å¤§å°å’Œä¸šåŠ¡é€»è¾‘å¤æ‚åº¦è€Œå¼‚*

## æ¶ˆæ¯æ ¼å¼

GoHub ä½¿ç”¨åŸºäº JSON çš„æ¶ˆæ¯æ ¼å¼ï¼š

```json
{
  "message_id": 123,          // å¯é€‰: æ¶ˆæ¯çš„å”¯ä¸€ ID (å®¢æˆ·ç«¯ç”Ÿæˆï¼Œç”¨äºè¯·æ±‚/å“åº”å…³è”)
  "message_type": "your_type", // å­—ç¬¦ä¸²: æ¶ˆæ¯ç±»å‹ (ä¾‹å¦‚ï¼š"ping", "join_room", "custom_action")
  "data": { ... },            // å¯¹è±¡: æ¶ˆæ¯çš„æœ‰æ•ˆè´Ÿè½½ï¼Œå…¶ç»“æ„å–å†³äº message_type
  "request_id": 456           // å¯é€‰: å¦‚æœè¿™æ˜¯ä¸€æ¡å“åº”æ¶ˆæ¯ï¼Œå®ƒå¯èƒ½å¯¹åº”åŸå§‹è¯·æ±‚çš„ message_id
}
```

å…³äºå†…ç½®æ¶ˆæ¯ç±»å‹ï¼ˆå¦‚ `ping`, `join_room`, `leave_room`, `room_message`, `direct_message`ï¼‰çš„ç¤ºä¾‹ï¼Œè¯·å‚è€ƒ `internal/handlers/handlers.go`ã€‚

## ğŸ› ï¸ API ç«¯ç‚¹

é™¤äº† `/ws` WebSocket ç«¯ç‚¹å¤–ï¼ŒGoHub è¿˜æš´éœ²äº†ä¸€äº› HTTP API ç«¯ç‚¹ï¼š

* **`/metrics`**: Prometheus æŒ‡æ ‡ï¼Œç”¨äºç›‘æ§
* **`/health`**: å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼Œè¿”å›æœåŠ¡å™¨çŠ¶æ€å’Œç‰ˆæœ¬
* **`/api/broadcast` (POST)**: å‘æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯å¹¿æ’­æ¶ˆæ¯ï¼Œè·¨é›†ç¾¤èŠ‚ç‚¹
  * è¯·æ±‚ä½“: `{"message": "your message content"}`
* **`/api/stats` (GET)**: è·å–æœåŠ¡å™¨ç»Ÿè®¡ä¿¡æ¯ (å®¢æˆ·ç«¯æ•°é‡ã€æˆ¿é—´æ•°é‡)
* **`/api/rooms` (GET, POST)**:
  * GET: åˆ—å‡ºæ‰€æœ‰æˆ¿é—´åŠå…¶æˆå‘˜æ•°é‡
  * POST: åˆ›å»ºä¸€ä¸ªæ–°æˆ¿é—´ã€‚è¯·æ±‚ä½“: `{"id": "room_id", "name": "Room Name", "max_clients": 100}`
* **`/api/clients` (GET)**: è·å–å®¢æˆ·ç«¯ç»Ÿè®¡ä¿¡æ¯

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

GoHub éµå¾ªæ ‡å‡†çš„ Go é¡¹ç›®å¸ƒå±€ï¼š

* **`cmd/gohub/`**: ä¸»åº”ç”¨ç¨‹åºå…¥å£å’ŒæœåŠ¡å™¨è®¾ç½®
* **`configs/`**: é…ç½®æ–‡ä»¶å’ŒåŠ è½½é€»è¾‘
* **`internal/`**: æ ¸å¿ƒå†…éƒ¨åŒ…ï¼š
  * `auth/`: è®¤è¯ (JWT) å’Œæˆæƒé€»è¾‘
  * `bus/`: æ¶ˆæ¯æ€»çº¿æ¥å£å’Œå®ç° (NATS, Redis, NoOp)
  * `dispatcher/`: å°†ä¼ å…¥çš„ WebSocket æ¶ˆæ¯è·¯ç”±åˆ°é€‚å½“çš„å¤„ç†å™¨
  * `handlers/`: WebSocket æ¶ˆæ¯çš„é»˜è®¤å¤„ç†å™¨
  * `hub/`: ç®¡ç† WebSocket å®¢æˆ·ç«¯ã€æˆ¿é—´å’Œæ¶ˆæ¯æµ
  * `metrics/`: Prometheus æŒ‡æ ‡æ”¶é›†
  * `sdk/`: ç”¨äºä¸šåŠ¡é€»è¾‘é›†æˆçš„æœåŠ¡ç«¯ SDK
  * `utils/`: é€šç”¨å·¥å…·å‡½æ•°
  * `websocket/`: WebSocket è¿æ¥é€‚é…å™¨æ¥å£å’Œå®ç°
* **`scripts/`**: å·¥å…·å’Œæµ‹è¯•è„šæœ¬

## ğŸ”§ æ‰©å±• GoHub (è‡ªå®šä¹‰æ¶ˆæ¯å¤„ç†å™¨)

æ‚¨å¯ä»¥ä¸ºç‰¹å®šäºåº”ç”¨ç¨‹åºçš„ WebSocket æ¶ˆæ¯æ·»åŠ è‡ªå®šä¹‰å¤„ç†å™¨ã€‚

**å½“å‰æ¨èæ–¹æ³•:**

GoHub ä½¿ç”¨ä¸€ä¸ªä¸­å¿ƒçš„ã€å•ä¾‹çš„åˆ†å‘å™¨ã€‚è¦åœ¨ä¸ä¿®æ”¹ GoHub å†…éƒ¨ä»£ç çš„æƒ…å†µä¸‹æ·»åŠ è‡ªå®šä¹‰æ¶ˆæ¯å¤„ç†å™¨ï¼Œæ‚¨å¯ä»¥åœ¨æ‚¨çš„ `main.go` (æˆ–åº”ç”¨ç¨‹åºè®¾ç½®ä»£ç ) ä¸­ï¼Œåœ¨ GoHub æœåŠ¡å™¨å®Œå…¨å¯åŠ¨*ä¹‹å‰*ï¼Œå°†å®ƒä»¬æ³¨å†Œåˆ°è¿™ä¸ªå…¨å±€åˆ†å‘å™¨å®ä¾‹ã€‚

**ç¤ºä¾‹ (åœ¨æ‚¨çš„ `cmd/gohub/main.go` ä¸­è¿›è¡Œæ¦‚å¿µæ€§ä¿®æ”¹):**

```go
// å°†æ­¤ä»£ç æ”¾åœ¨è°ƒç”¨ NewGoHubServer å’Œ server.Start() ä¹‹å‰

import (
	"gohub/internal/dispatcher"
	"gohub/internal/hub" // ç”¨äº hub.Client ç±»å‹å’Œ hub.Frame
	"gohub/internal/websocket" // ç”¨äºæ¶ˆæ¯ç±»å‹å¦‚ websocket.TextMessage
	"encoding/json"
	"context"
	"log/slog"
	// ... å…¶ä»–å¿…è¦çš„å¯¼å…¥
)

// 1. å®šä¹‰æ‚¨çš„è‡ªå®šä¹‰å¤„ç†å‡½æ•°
//    å®ƒåº”è¯¥åŒ¹é… dispatcher.HandlerFunc ç­¾å
func handleMyCustomAction(ctx context.Context, client *hub.Client, data json.RawMessage) error {
    slog.Info("æ­£åœ¨å¤„ç† 'my_custom_action'", "client_id", client.ID(), "payload", string(data))
    
    var requestPayload struct {
        // å®šä¹‰æ‚¨çš„è‡ªå®šä¹‰æ¶ˆæ¯æ•°æ®ä¸­çš„é¢„æœŸå­—æ®µ
        ActionDetail string `json:"action_detail"`
    }
    if err := json.Unmarshal(data, &requestPayload); err != nil {
        slog.Error("è§£æè‡ªå®šä¹‰æ“ä½œè´Ÿè½½å¤±è´¥", "error", err, "client_id", client.ID())
        // å¯é€‰ï¼šå‘å®¢æˆ·ç«¯å‘é€é”™è¯¯å“åº”
        errorResp := hub.NewError(hub.ErrCodeInvalidFormat, "my_custom_action çš„è´Ÿè½½æ— æ•ˆ", 0, err.Error()) // å‡è®¾åœ¨æ²¡æœ‰å¯ç”¨è¯·æ±‚ ID æ—¶ä½¿ç”¨ 0
        errorMsgJson, _ := errorResp.ToJSON()
        _ = client.Send(hub.Frame{MsgType: websocket.TextMessage, Data: errorMsgJson})
        return err 
    }

    slog.Info("è‡ªå®šä¹‰æ“ä½œè¯¦æƒ…", "client_id", client.ID(), "detail", requestPayload.ActionDetail)

    // ... æ‚¨çš„ä¸šåŠ¡é€»è¾‘ä»£ç  ...

    // ç¤ºä¾‹ï¼šå‘é€æˆåŠŸå›å¤
    replyData := map[string]interface{}{"status": "success", "action_processed": "my_custom_action", "detail_received": requestPayload.ActionDetail}
    // ä¸ºå›å¤æ„å»ºä¸€ä¸ª hub.Message
    // å‡è®¾æ‚¨æœ‰ç”Ÿæˆæ¶ˆæ¯ ID çš„æ–¹æ³•ï¼Œæˆ–è€…è¿™æ˜¯ä¸€ä¸ªæœåŠ¡å™¨æ¨é€ï¼Œæ²¡æœ‰æ˜¾å¼çš„ request_id åŒ¹é…
    responseHubMsg, err := hub.NewMessage(0, "my_custom_action_reply", replyData) // ä½¿ç”¨ 0 ä½œä¸ºå ä½æ¶ˆæ¯ ID
    if err != nil {
         slog.Error("åˆ›å»ºå›å¤æ¶ˆæ¯å¤±è´¥", "error", err, "client_id", client.ID())
        return err
    }
    encodedReply, err := responseHubMsg.Encode()
    if err != nil {
        slog.Error("ç¼–ç å›å¤æ¶ˆæ¯å¤±è´¥", "error", err, "client_id", client.ID())
        return err
    }
    
    return client.Send(hub.Frame{MsgType: websocket.TextMessage, Data: encodedReply})
}

// åœ¨æ‚¨çš„ main å‡½æ•°ä¸­:
func main() {
    // ... (ç°æœ‰è®¾ç½®ï¼šflag.Parse(), åŠ è½½é…ç½®, è®¾ç½®æ—¥å¿—è®°å½•å™¨) ...
	config, err := configs.LoadConfig(*configFile) // ç¤ºä¾‹
	// ... (å¤„ç†é”™è¯¯) ...
	// æ ¹æ® config.Log.Level è®¾ç½®æ—¥å¿—è®°å½•å™¨
	// ...

    // 2. è·å–å…¨å±€åˆ†å‘å™¨å®ä¾‹
    d := dispatcher.GetDispatcher() //

    // 3. æ³¨å†Œæ‚¨çš„è‡ªå®šä¹‰å¤„ç†å™¨
    d.Register("my_custom_action", handleMyCustomAction)
    slog.Info("å·²æ³¨å†Œè‡ªå®šä¹‰æ¶ˆæ¯å¤„ç†å™¨ã€‚")

    // åˆå§‹åŒ–å¹¶å¯åŠ¨ GoHub æœåŠ¡å™¨
    // NewGoHubServer å†…éƒ¨ä¼šä¸ºå†…ç½®ç±»å‹è°ƒç”¨ handlers.RegisterHandlersï¼Œ
    // è¿™ä¼šæ·»åŠ åˆ°åŒä¸€ä¸ªåˆ†å‘å™¨å®ä¾‹ä¸­ã€‚
    server, err := NewGoHubServer(&config) //
    if err != nil {
        slog.Error("åˆ›å»ºæœåŠ¡å™¨å¤±è´¥", "error", err)
        os.Exit(1)
    }
    
    // ... (main å‡½æ•°çš„å…¶ä½™éƒ¨åˆ†ï¼šä¼˜é›…å…³é—­, server.Start()) ...
}
```
*æœªæ¥ç‰ˆæœ¬çš„ GoHub SDK å¯èƒ½ä¼šæä¾›æ›´ç›´æ¥çš„å¤„ç†å™¨æ³¨å†Œæ–¹æ³•ï¼Œä»¥å®ç°æ›´å°è£…çš„æ–¹å¼ã€‚*

## ğŸ§ª æµ‹è¯•

GoHub åŒ…å«ä¸€å¥—å…¨é¢çš„æµ‹è¯•ï¼š

* **å•å…ƒæµ‹è¯•**: ä¸ä»£ç ä¸€èµ·ä½äº `_test.go` æ–‡ä»¶ä¸­ (ä¾‹å¦‚, `internal/bus/nats/nats_test.go`)
* **é›†æˆæµ‹è¯•**: ä½äº `internal/integration/` å’Œ `cmd/gohub/` çš„éƒ¨åˆ†å†…å®¹ï¼Œç”¨äºæœåŠ¡å™¨çº§æµ‹è¯•
* **å‹åŠ›æµ‹è¯•**: `cmd/gohub/stress_test.go` è¯„ä¼°é«˜è´Ÿè½½ä¸‹çš„æ€§èƒ½
* **åˆ†å¸ƒå¼æµ‹è¯•**: `cmd/gohub/redis_distributed_test.go` ä¸“é—¨æµ‹è¯•ä½¿ç”¨ Redis çš„é›†ç¾¤åŠŸèƒ½
* **Shell è„šæœ¬**: `scripts/` ç›®å½•åŒ…å«ç”¨äºè¿è¡Œå„ç§æµ‹è¯•çš„è„šæœ¬
  * `scripts/test_nats.sh`: æµ‹è¯• NATS åŠŸèƒ½
  * `test_broadcast.sh` / `test_redis_broadcast.sh`: ç«¯åˆ°ç«¯å¹¿æ’­æµ‹è¯•

è¿è¡Œæµ‹è¯• (å‡è®¾ç›¸å…³æµ‹è¯•ä¾èµ–å¦‚ NATS/Redis å¯ç”¨):
```bash
go test ./...
# æˆ–è€…ä½¿ç”¨ scripts/ ç›®å½•ä¸‹çš„ç‰¹å®šè„šæœ¬ï¼Œä¾‹å¦‚ï¼š
./scripts/test_bus.sh 
```

## ğŸ’¡ å¸¸è§é—®é¢˜è§£ç­”

### 1. GoHubä¸åŸºç¡€æ¡†æ¶Gorilla WebSocketçš„å…³ç³»ï¼Ÿ

GoHubå»ºç«‹åœ¨Gorilla WebSocketä¹‹ä¸Šï¼ŒGorillaæä¾›äº†åŸºç¡€çš„WebSocketåè®®å®ç°ï¼Œè€ŒGoHubåˆ™æä¾›äº†å®Œæ•´çš„åˆ†å¸ƒå¼æ¶æ„ã€æˆ¿é—´ç®¡ç†ã€æ¶ˆæ¯åˆ†å‘å’Œé›†ç¾¤é€šä¿¡ç­‰ä¼ä¸šçº§åŠŸèƒ½ã€‚GoHubå¯ä»¥çœ‹ä½œæ˜¯å¯¹Gorilla WebSocketçš„ä¸€ä¸ªé«˜çº§æŠ½è±¡å’ŒåŠŸèƒ½æ‰©å±•ï¼Œä½¿å…¶æ›´é€‚åˆæ„å»ºå¤æ‚çš„å®æ—¶åº”ç”¨ã€‚

### 2. å¦‚ä½•å®ç°è·¨èŠ‚ç‚¹çš„æ¶ˆæ¯ä¼ é€’ï¼Ÿ

GoHubä½¿ç”¨æ¶ˆæ¯æ€»çº¿ï¼ˆNATSæˆ–Redisï¼‰åœ¨é›†ç¾¤èŠ‚ç‚¹é—´ä¼ é€’æ¶ˆæ¯ã€‚å½“ä¸€ä¸ªèŠ‚ç‚¹éœ€è¦å‘è¿æ¥åˆ°å…¶ä»–èŠ‚ç‚¹çš„å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯æ—¶ï¼Œå®ƒä¼šé€šè¿‡æ¶ˆæ¯æ€»çº¿å¹¿æ’­è¿™ä¸ªæ¶ˆæ¯ã€‚å…¶ä»–èŠ‚ç‚¹ä¼šæ¥æ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯ï¼Œå¹¶å°†å…¶è½¬å‘ç»™ç›¸åº”çš„å®¢æˆ·ç«¯ã€‚æ•´ä¸ªè¿‡ç¨‹å¯¹å¼€å‘è€…é€æ˜ï¼Œæ‚¨åªéœ€æ­£å¸¸ä½¿ç”¨APIï¼Œä¸éœ€è¦å…³å¿ƒå®¢æˆ·ç«¯è¿æ¥åœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šã€‚

### 3. GoHubçš„åˆ†å¸ƒå¼æ¶æ„å¦‚ä½•æé«˜ç³»ç»Ÿå¯é æ€§ï¼Ÿ

GoHubçš„åˆ†å¸ƒå¼è®¾è®¡å¸¦æ¥å‡ ä¸ªå…³é”®ä¼˜åŠ¿ï¼š
- **é«˜å¯ç”¨æ€§**ï¼šå•ä¸ªèŠ‚ç‚¹æ•…éšœä¸ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿ
- **æ°´å¹³æ‰©å±•**ï¼šå¯ä»¥é€šè¿‡æ·»åŠ æ›´å¤šèŠ‚ç‚¹æ¥å¢åŠ ç³»ç»Ÿå®¹é‡
- **è´Ÿè½½å‡è¡¡**ï¼šè¿æ¥å¯ä»¥åˆ†æ•£åˆ°å¤šä¸ªèŠ‚ç‚¹ä¸Š
- **åœ°ç†åˆ†å¸ƒ**ï¼šèŠ‚ç‚¹å¯ä»¥éƒ¨ç½²åœ¨ä¸åŒåŒºåŸŸï¼Œå‡å°‘å»¶è¿Ÿ

### 4. å¦‚ä½•ç›‘æ§é›†ç¾¤çŠ¶æ€ï¼Ÿ

GoHubé€šè¿‡PrometheusæŒ‡æ ‡æä¾›å…¨é¢çš„ç›‘æ§èƒ½åŠ›ï¼ŒåŒ…æ‹¬æ¯ä¸ªèŠ‚ç‚¹çš„è¿æ¥æ•°ã€æ¶ˆæ¯å¤„ç†é‡ã€æˆ¿é—´æ•°é‡ç­‰ã€‚æ‚¨å¯ä»¥ä½¿ç”¨Grafanaåˆ›å»ºä»ªè¡¨æ¿æ¥å¯è§†åŒ–è¿™äº›æŒ‡æ ‡ï¼Œå®æ—¶ç›‘æ§é›†ç¾¤å¥åº·çŠ¶å†µã€‚

## ğŸ¤ è´¡çŒ®

æ¬¢è¿è´¡çŒ®ï¼è¯·éšæ—¶æäº¤ Pull Request æˆ–å¼€å¯ Issueã€‚

åœ¨è´¡çŒ®ä¹‹å‰ï¼Œè¯·ï¼š
1.  ç¡®ä¿æ‚¨çš„ä»£ç ç¬¦åˆ Go çš„æœ€ä½³å®è·µå’Œé¡¹ç›®ç°æœ‰é£æ ¼ã€‚
2.  ä¸ºæ‚¨çš„æ›´æ”¹ç¼–å†™æˆ–æ›´æ–°æµ‹è¯•ã€‚
3.  ä½¿ç”¨ `go fmt` æˆ– `gofumpt` æ ¼å¼åŒ–æ‚¨çš„ä»£ç ã€‚
4.  è€ƒè™‘è¿è¡Œ `go vet` å’Œ `golangci-lint` (å¦‚æœæä¾›äº†é…ç½®æ–‡ä»¶)ã€‚

## ğŸ“œ è®¸å¯è¯

GoHub ä½¿ç”¨ MIT è®¸å¯è¯ã€‚è¯¦æƒ…è¯·å‚é˜…ä»“åº“æ ¹ç›®å½•ä¸‹çš„ `LICENSE` æ–‡ä»¶ã€‚ 